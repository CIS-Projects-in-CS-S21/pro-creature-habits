{"version":3,"sources":["useLinking.native.tsx"],"names":["isUsingLinking","useLinking","ref","enabled","prefixes","config","getInitialURL","Promise","race","Linking","resolve","setTimeout","subscribe","listener","callback","url","addEventListener","removeEventListener","getStateFromPath","getStateFromPathDefault","getActionFromState","getActionFromStateDefault","React","useEffect","Error","Platform","OS","join","trim","enabledRef","useRef","prefixesRef","configRef","getInitialURLRef","getStateFromPathRef","getActionFromStateRef","current","getInitialState","useCallback","state","then","path","undefined","thenable","onfulfilled","catch","navigation","rootState","getRootState","routes","some","r","routeNames","includes","name","console","warn","action","dispatch","e","message","resetRoot"],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { Linking, Platform } from 'react-native';\nimport {\n  getActionFromState as getActionFromStateDefault,\n  getStateFromPath as getStateFromPathDefault,\n  NavigationContainerRef,\n} from '@react-navigation/core';\nimport extractPathFromURL from './extractPathFromURL';\nimport type { LinkingOptions } from './types';\n\ntype ResultState = ReturnType<typeof getStateFromPathDefault>;\n\nlet isUsingLinking = false;\n\nexport default function useLinking(\n  ref: React.RefObject<NavigationContainerRef>,\n  {\n    enabled = true,\n    prefixes,\n    config,\n    getInitialURL = () =>\n      Promise.race([\n        Linking.getInitialURL(),\n        new Promise<undefined>((resolve) =>\n          // Timeout in 150ms if `getInitialState` doesn't resolve\n          // Workaround for https://github.com/facebook/react-native/issues/25675\n          setTimeout(resolve, 150)\n        ),\n      ]),\n    subscribe = (listener) => {\n      const callback = ({ url }: { url: string }) => listener(url);\n\n      Linking.addEventListener('url', callback);\n\n      return () => Linking.removeEventListener('url', callback);\n    },\n    getStateFromPath = getStateFromPathDefault,\n    getActionFromState = getActionFromStateDefault,\n  }: LinkingOptions\n) {\n  React.useEffect(() => {\n    if (enabled !== false && isUsingLinking) {\n      throw new Error(\n        [\n          'Looks like you have configured linking in multiple places. This is likely an error since deep links should only be handled in one place to avoid conflicts. Make sure that:',\n          \"- You are not using both 'linking' prop and 'useLinking'\",\n          \"- You don't have 'useLinking' in multiple components\",\n          Platform.OS === 'android'\n            ? \"- You have set 'android:launchMode=singleTask' in the '<activity />' section of the 'AndroidManifest.xml' file to avoid launching multiple instances\"\n            : '',\n        ]\n          .join('\\n')\n          .trim()\n      );\n    } else {\n      isUsingLinking = enabled !== false;\n    }\n\n    return () => {\n      isUsingLinking = false;\n    };\n  });\n\n  // We store these options in ref to avoid re-creating getInitialState and re-subscribing listeners\n  // This lets user avoid wrapping the items in `React.useCallback` or `React.useMemo`\n  // Not re-creating `getInitialState` is important coz it makes it easier for the user to use in an effect\n  const enabledRef = React.useRef(enabled);\n  const prefixesRef = React.useRef(prefixes);\n  const configRef = React.useRef(config);\n  const getInitialURLRef = React.useRef(getInitialURL);\n  const getStateFromPathRef = React.useRef(getStateFromPath);\n  const getActionFromStateRef = React.useRef(getActionFromState);\n\n  React.useEffect(() => {\n    enabledRef.current = enabled;\n    prefixesRef.current = prefixes;\n    configRef.current = config;\n    getInitialURLRef.current = getInitialURL;\n    getStateFromPathRef.current = getStateFromPath;\n    getActionFromStateRef.current = getActionFromState;\n  });\n\n  const getInitialState = React.useCallback(() => {\n    let state: ResultState | undefined;\n\n    if (enabledRef.current) {\n      const url = getInitialURLRef.current();\n\n      if (url != null && typeof url !== 'string') {\n        return url.then((url) => {\n          const path = url\n            ? extractPathFromURL(prefixesRef.current, url)\n            : null;\n\n          return path\n            ? getStateFromPathRef.current(path, configRef.current)\n            : undefined;\n        });\n      }\n\n      const path = url ? extractPathFromURL(prefixesRef.current, url) : null;\n\n      state = path\n        ? getStateFromPathRef.current(path, configRef.current)\n        : undefined;\n    }\n\n    const thenable = {\n      then(onfulfilled?: (state: ResultState | undefined) => void) {\n        return Promise.resolve(onfulfilled ? onfulfilled(state) : state);\n      },\n      catch() {\n        return thenable;\n      },\n    };\n\n    return thenable as PromiseLike<ResultState | undefined>;\n  }, []);\n\n  React.useEffect(() => {\n    const listener = (url: string) => {\n      if (!enabled) {\n        return;\n      }\n\n      const path = extractPathFromURL(prefixesRef.current, url);\n      const navigation = ref.current;\n\n      if (navigation && path) {\n        const state = getStateFromPathRef.current(path, configRef.current);\n\n        if (state) {\n          // Make sure that the routes in the state exist in the root navigator\n          // Otherwise there's an error in the linking configuration\n          const rootState = navigation.getRootState();\n\n          if (\n            state.routes.some((r) => !rootState?.routeNames.includes(r.name))\n          ) {\n            console.warn(\n              \"The navigation state parsed from the URL contains routes not present in the root navigator. This usually means that the linking configuration doesn't match the navigation structure. See https://reactnavigation.org/docs/configuring-links for more details on how to specify a linking configuration.\"\n            );\n            return;\n          }\n\n          const action = getActionFromStateRef.current(\n            state,\n            configRef.current\n          );\n\n          if (action !== undefined) {\n            try {\n              navigation.dispatch(action);\n            } catch (e) {\n              // Ignore any errors from deep linking.\n              // This could happen in case of malformed links, navigation object not being initialized etc.\n              console.warn(\n                `An error occurred when trying to handle the link '${path}': ${e.message}`\n              );\n            }\n          } else {\n            navigation.resetRoot(state);\n          }\n        }\n      }\n    };\n\n    return subscribe(listener);\n  }, [enabled, ref, subscribe]);\n\n  return {\n    getInitialState,\n  };\n}\n"]}