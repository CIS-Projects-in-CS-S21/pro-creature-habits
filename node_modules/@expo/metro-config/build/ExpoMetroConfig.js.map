{"version":3,"file":"ExpoMetroConfig.js","sourceRoot":"","sources":["../src/ExpoMetroConfig.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA,yCAA+D;AAC/D,8CAA6E;AAG7E,gDAAwB;AACxB,gEAAuC;AAEvC,wFAAwF;AACxF,MAAM,wBAAwB,GAAG,IAAI,MAAM,CACzC;IACE,8CAA8C;IAC9C,6CAA6C;IAC7C,+BAA+B;IAC/B,4BAA4B;IAC5B,iCAAiC;IACjC,4CAA4C;IAC5C,sCAAsC;IACtC,kCAAkC;CACnC,CAAC,IAAI,CAAC,GAAG,CAAC,CACZ,CAAC;AAMF,SAAgB,gBAAgB,CAC9B,WAAmB,EACnB,UAAgC,EAAE;;IAElC,MAAM,WAAW,GAAG,4BAA4B,CAAC,WAAW,CAAC,CAAC;IAE9D,MAAM,eAAe,GAAG,cAAI,CAAC,OAAO,CAAC,sBAAW,CAAC,WAAW,EAAE,2BAA2B,CAAC,CAAC,CAAC;IAE5F,IAAI,kBAAkB,CAAC;IACvB,IAAI;QACF,kBAAkB,GAAG,sBAAW,CAAC,WAAW,EAAE,iCAAiC,CAAC,CAAC;KAClF;IAAC,WAAM;QACN,0FAA0F;QAC1F,yFAAyF;QACzF,uFAAuF;QACvF,mBAAmB;KACpB;IAED,MAAM,MAAM,eAAG,OAAO,CAAC,MAAM,mCAAI,OAAO,CAAC,GAAG,CAAC,WAAW,mCAAI,yBAAgB,CAAC,WAAW,CAAC,CAAC;IAC1F,IAAI,CAAC,CAAC,MAAM,KAAK,SAAS,IAAI,MAAM,KAAK,MAAM,CAAC,EAAE;QAChD,MAAM,IAAI,KAAK,CACb,oBAAoB,MAAM,oBAAoB,IAAI,CAAC,SAAS,CAC1D;YACE,gBAAgB,EAAE,OAAO,CAAC,MAAM;YAChC,WAAW,EAAE,OAAO,CAAC,GAAG,CAAC,WAAW;YACpC,OAAO,EAAE,yBAAgB,CAAC,WAAW,CAAC;SACvC,EACD,IAAI,EACJ,CAAC,CACF,EAAE,CACJ,CAAC;KACH;IACD,MAAM,gBAAgB,GAAG,EAAE,IAAI,EAAE,IAAI,EAAE,OAAO,EAAE,IAAI,EAAE,QAAQ,EAAE,KAAK,EAAE,CAAC;IACxE,MAAM,UAAU,GACd,MAAM,KAAK,MAAM;QACf,CAAC,CAAC,yBAAiB,CAAC,EAAE,EAAE,gBAAgB,CAAC;QACzC,CAAC,CAAC,4BAAoB,CAAC,EAAE,EAAE,gBAAgB,CAAC,CAAC;IAEjD,MAAM,kBAAkB,GAAG,WAAW,CAAC,gBAAgB,CAAC,gBAAgB,CAAC,WAAW,CAAC,CAAC;IACtF,2FAA2F;IAC3F,+FAA+F;IAC/F,OAAO,WAAW,CAAC,WAAW,CAAC,kBAAkB,EAAE;QACjD,QAAQ,EAAE;YACR,kBAAkB,EAAE,CAAC,cAAc,EAAE,SAAS,EAAE,MAAM,CAAC;YACvD,SAAS,EAAE,CAAC,KAAK,EAAE,SAAS,EAAE,QAAQ,CAAC;YACvC,UAAU;SACX;QACD,UAAU,EAAE;YACV,6BAA6B,EAAE,GAAG,EAAE,CAAC;gBACnC,OAAO,CAAC,OAAO,CAAC,cAAI,CAAC,IAAI,CAAC,eAAe,EAAE,+BAA+B,CAAC,CAAC;aAE7E;YACD,YAAY,EAAE,GAAG,EAAE,CAAC,OAAO,CAAC,cAAI,CAAC,IAAI,CAAC,eAAe,EAAE,kBAAkB,CAAC,CAAC,EAAE;SAC9E;QACD,MAAM,EAAE;YACN,IAAI,EAAE,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,cAAc,CAAC,IAAI,IAAI;SACjD;QACD,YAAY,EAAE;YACZ,cAAc,EAAE,CAAC,KAA8B,EAAE,EAAE;gBACjD,MAAM,QAAQ,GAAG,OAAO,CAAC,KAAK,CAAC,IAAI,IAAI,wBAAwB,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC;gBAClF,OAAO,EAAE,QAAQ,EAAE,CAAC;YACtB,CAAC;SACF;QACD,WAAW,EAAE;YACX,yBAAyB,EAAE,IAAI;YAC/B,oBAAoB,EAAE,OAAO,CAAC,OAAO,CAAC,sCAAsC,CAAC;YAC7E,yCAAyC;YACzC,iBAAiB,EAAE,cAAI,CAAC,IAAI,CAAC,eAAe,EAAE,+BAA+B,CAAC;YAC9E,YAAY,EAAE,kBAAkB,CAAC,CAAC,CAAC,CAAC,kBAAkB,CAAC,CAAC,CAAC,CAAC,SAAS;SACpE;KACF,CAAC,CAAC;AACL,CAAC;AAvED,4CAuEC;AAWM,KAAK,UAAU,SAAS,CAC7B,WAAmB,EACnB,KAAqD,EAAE;QAAvD,EAAE,QAAQ,EAAE,MAAM,OAAqC,EAAnC,iDAAe;IAEnC,IAAI,aAAa,GAAG,gBAAgB,CAAC,WAAW,EAAE,EAAE,MAAM,EAAE,CAAC,CAAC;IAC9D,IAAI,QAAQ,EAAE;QACZ,aAAa,mCAAQ,aAAa,KAAE,QAAQ,GAAE,CAAC;KAChD;IACD,MAAM,WAAW,GAAG,4BAA4B,CAAC,WAAW,CAAC,CAAC;IAC9D,OAAO,MAAM,WAAW,CAAC,UAAU,iBAC/B,GAAG,EAAE,WAAW,EAAE,WAAW,IAAK,YAAY,GAChD,aAAa,CACd,CAAC;AACJ,CAAC;AAbD,8BAaC;AAED,SAAS,4BAA4B,CAAC,WAAmB;IACvD,MAAM,YAAY,GAAG,sBAAW,CAAC,MAAM,CAAC,WAAW,EAAE,cAAc,CAAC,CAAC;IACrE,IAAI,CAAC,YAAY,EAAE;QACjB,MAAM,IAAI,KAAK,CACb,iDAAiD;YAC/C,sDAAsD;YACtD,yEAAyE;YACzE,kCAAkC,CACrC,CAAC;KACH;IACD,OAAO,OAAO,CAAC,YAAY,CAAC,CAAC;AAC/B,CAAC","sourcesContent":["import { getDefaultTarget, ProjectTarget } from '@expo/config';\nimport { getBareExtensions, getManagedExtensions } from '@expo/config/paths';\nimport { Reporter } from 'metro';\nimport type MetroConfig from 'metro-config';\nimport path from 'path';\nimport resolveFrom from 'resolve-from';\n\n// Import only the types here, the values will be imported from the project, at runtime.\nconst INTERNAL_CALLSITES_REGEX = new RegExp(\n  [\n    '/Libraries/Renderer/implementations/.+\\\\.js$',\n    '/Libraries/BatchedBridge/MessageQueue\\\\.js$',\n    '/Libraries/YellowBox/.+\\\\.js$',\n    '/Libraries/LogBox/.+\\\\.js$',\n    '/Libraries/Core/Timers/.+\\\\.js$',\n    '/node_modules/react-devtools-core/.+\\\\.js$',\n    '/node_modules/react-refresh/.+\\\\.js$',\n    '/node_modules/scheduler/.+\\\\.js$',\n  ].join('|')\n);\n\nexport interface DefaultConfigOptions {\n  target?: ProjectTarget;\n}\n\nexport function getDefaultConfig(\n  projectRoot: string,\n  options: DefaultConfigOptions = {}\n): MetroConfig.InputConfigT {\n  const MetroConfig = importMetroConfigFromProject(projectRoot);\n\n  const reactNativePath = path.dirname(resolveFrom(projectRoot, 'react-native/package.json'));\n\n  let hashAssetFilesPath;\n  try {\n    hashAssetFilesPath = resolveFrom(projectRoot, 'expo-asset/tools/hashAssetFiles');\n  } catch {\n    // TODO: we should warn/throw an error if the user has expo-updates installed but does not\n    // have hashAssetFiles available, or if the user is in managed workflow and does not have\n    // hashAssetFiles available. but in a bare app w/o expo-updates, just using dev-client,\n    // it is not needed\n  }\n\n  const target = options.target ?? process.env.EXPO_TARGET ?? getDefaultTarget(projectRoot);\n  if (!(target === 'managed' || target === 'bare')) {\n    throw new Error(\n      `Invalid target: '${target}'. Debug info: \\n${JSON.stringify(\n        {\n          'options.target': options.target,\n          EXPO_TARGET: process.env.EXPO_TARGET,\n          default: getDefaultTarget(projectRoot),\n        },\n        null,\n        2\n      )}`\n    );\n  }\n  const sourceExtsConfig = { isTS: true, isReact: true, isModern: false };\n  const sourceExts =\n    target === 'bare'\n      ? getBareExtensions([], sourceExtsConfig)\n      : getManagedExtensions([], sourceExtsConfig);\n\n  const metroDefaultValues = MetroConfig.getDefaultConfig.getDefaultValues(projectRoot);\n  // Merge in the default config from Metro here, even though loadConfig uses it as defaults.\n  // This is a convenience for getDefaultConfig use in metro.config.js, e.g. to modify assetExts.\n  return MetroConfig.mergeConfig(metroDefaultValues, {\n    resolver: {\n      resolverMainFields: ['react-native', 'browser', 'main'],\n      platforms: ['ios', 'android', 'native'],\n      sourceExts,\n    },\n    serializer: {\n      getModulesRunBeforeMainModule: () => [\n        require.resolve(path.join(reactNativePath, 'Libraries/Core/InitializeCore')),\n        // TODO: Bacon: load Expo side-effects\n      ],\n      getPolyfills: () => require(path.join(reactNativePath, 'rn-get-polyfills'))(),\n    },\n    server: {\n      port: Number(process.env.RCT_METRO_PORT) || 8081,\n    },\n    symbolicator: {\n      customizeFrame: (frame: { file: string | null }) => {\n        const collapse = Boolean(frame.file && INTERNAL_CALLSITES_REGEX.test(frame.file));\n        return { collapse };\n      },\n    },\n    transformer: {\n      allowOptionalDependencies: true,\n      babelTransformerPath: require.resolve('metro-react-native-babel-transformer'),\n      // TODO: Bacon: Add path for web platform\n      assetRegistryPath: path.join(reactNativePath, 'Libraries/Image/AssetRegistry'),\n      assetPlugins: hashAssetFilesPath ? [hashAssetFilesPath] : undefined,\n    },\n  });\n}\n\nexport interface LoadOptions {\n  config?: string;\n  maxWorkers?: number;\n  port?: number;\n  reporter?: Reporter;\n  resetCache?: boolean;\n  target?: ProjectTarget;\n}\n\nexport async function loadAsync(\n  projectRoot: string,\n  { reporter, target, ...metroOptions }: LoadOptions = {}\n): Promise<MetroConfig.ConfigT> {\n  let defaultConfig = getDefaultConfig(projectRoot, { target });\n  if (reporter) {\n    defaultConfig = { ...defaultConfig, reporter };\n  }\n  const MetroConfig = importMetroConfigFromProject(projectRoot);\n  return await MetroConfig.loadConfig(\n    { cwd: projectRoot, projectRoot, ...metroOptions },\n    defaultConfig\n  );\n}\n\nfunction importMetroConfigFromProject(projectRoot: string): typeof MetroConfig {\n  const resolvedPath = resolveFrom.silent(projectRoot, 'metro-config');\n  if (!resolvedPath) {\n    throw new Error(\n      'Missing package \"metro-config\" in the project. ' +\n        'This usually means `react-native` is not installed. ' +\n        'Please verify that dependencies in package.json include \"react-native\" ' +\n        'and run `yarn` or `npm install`.'\n    );\n  }\n  return require(resolvedPath);\n}\n"]}